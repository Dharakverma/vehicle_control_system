\documentclass[12pt, titlepage]{article}

\usepackage{amsmath, mathtools}

\usepackage[round]{natbib}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{colortbl}
\usepackage{xr}
\usepackage{hyperref}
\usepackage{longtable}
\usepackage{xfrac}
\usepackage{tabularx}
\usepackage{float}
\usepackage{siunitx}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage[section]{placeins}
\usepackage{caption}
\usepackage{fullpage}

\newcommand{\tableVspace}{5mm}
\newcommand{\TID}{0.05\textwidth}
\newcommand{\Requirement}{0.14\textwidth}
\newcommand{\TestInput}{0.16\textwidth}
\newcommand{\ExpResult}{0.23\textwidth}
\newcommand{\ActResult}{0.23\textwidth}
\newcommand{\Result}{0.06\textwidth}


\input{../Comments}
\input{../Common}

\begin{document}

\title{Verification and Validation Report: \progname} 
\author{\authname}
\date{\today}
	
\maketitle

\pagenumbering{roman}

\section*{Revision History}

\begin{tabularx}{\textwidth}{p{3cm}p{2cm}X}
\toprule {\bf Date} & {\bf Version} & {\bf Notes}\\
\midrule
03/08/23 & 1.0 & \\
\bottomrule
\end{tabularx}

~\newpage

\section*{Symbols, Abbreviations and Acronyms}

See SRS Documentation \href{https://github.com/Dharakverma/vehicle_control_system/blob/main/docs/SRS/SRS.pdf}{here}.

\newpage

\tableofcontents


\listoffigures %if appropriate

\newpage

\pagenumbering{arabic}

This document provides the results of unit tests and integration tests the system underwent according to the \href{https://github.com/Dharakverma/vehicle_control_system/blob/main/docs/VnVPlan/VnV_Plan.pdf}{VnV Plan} documentation and to ensure requirements layed out in the \href{https://github.com/Dharakverma/vehicle_control_system/blob/main/docs/SRS/SRS.pdf}{SRS} are met and traceable to tests performed.

\section{Functional Requirements Evaluation}

Based on the results in Sections 3 \& 4, our control system meets basic functionality requirements. This VnV Report has prompted the team to generate a more comprehensive selection of requirements and tests, on the unit and system level, which will be reflected in the final documentation.

\section{Nonfunctional Requirements Evaluation}

All non-functional requirements, although subjecive in certain cases, have been met to some degree.

\subsection{Look and Feel}
NFR1 - (SRS: The control system Simulink models shall follow a standardized
format that facilitates readability and encapsulation)\\

The control models followed the following variable naming scheme:\\
OriginNode\_QuantityType\_VariableDescription\\\\
Example: DI\_p\_BrakePedalPosition
\begin{itemize}
    \item OriginNode - Driver Interface
    \item QuantityType - 'p' denotes percentage (0-100). 'V' is used for voltage, 'T' for a torque value, etc.
\end{itemize}

Example: VD\_n\_LeftMotorSpeedRequest\\
\begin{itemize}
    \item OriginNode - Vehicle Dynamics
    \item QuantityType - 'n' denotes speed
\end{itemize}

This naming scheme made development, debugging, and maintaining the model much easier. Since finding the exact reference to a signal can be cumbersome in Simulink, our naming scheme greatly decreased the time and effort required to understand a model or set of blocks. On top of that, when the control system was converted to C code, the naming scheme was a great aid in integrating the relevant input and output variables into the embedded C layer, as we knew exactly where the signal came from, where it was going, and what its purpose was. 

\subsection{Usability}

NFR2 - (SRS: The control system build target shall be the team-selected microcontroller
platform, STM32F7)\\

The Simulink model was successfully converted into C code using the Simulink code generation toolkit. The autogenerated code was then integrated into our embedded C wrapped and successfully flashed onto MFE's STM32F767ZI Front Controller ECU. The Front Controller was able to step through the control system at its required periodicity, supply all required inputs via CAN, SPI, UART, and I2C communication protocols, and successfully take the control system outputs and propagate them to the motor controllers.

\subsection{Performance}

NFR3 - (SRS: Running the control system on the embedded controller shall not exceed the
computational throughput of the controller.)\\

After utilizing the C Code Generation tool in Simulink, we were prompted to run the "step" function for the model at a certain periodicity. This periodicity, which Simulink had calculated internally and requested us to set, was the speed at which the control system would be refreshed and updated with new inputs and outputs. For our model, Simulink deemed that it must be refreshed a minimum of every 200ms for the C code to function exactly as the Simulink models did during our testing. This 200ms scan periodicity is used by the Simulink-generated C code to control timers, counters, delays, etc. (anything time-based), and any deviations from the 200ms periodicity of the step function would break the internal timing logic of the system. \\

Due to the above reasons, we decided it was wise to avoid messing with the scan rate of our control system and instead left it up to Simulink's discretion.

\subsection{Maintainability and Support}

NFR4 - (SRS: The control system shall make use of hardware abstraction modules, that have consistent outputs to our system regardless of changing the underlying hardware) \\

Hardware hiding in our build-model has been achieved by using our CAN hardware supplier's Simulink blockset, which allows our models to write signals to the vehicle's CAN bus simply by sending it to another block. The underlying implementation of the CAN transmission and reception is unknown to the control system. Similarly, the potentometer inputs (pedals, steering) have been hidden under the Formula team's embedded C GPIO layer.

NFR5 - (SRS: The control system modules shall incorporate modularization principles,
including encapsulation and information hiding.)\\

The control system's architecture, as explained in Design Documents, has been developed from the start as a modularized system, with each subsystem handling an unique category of functionality in which the implementation is unknown to the other modules.

\subsection{Security and Support}

The non-functional requirements listed below are self evident and do not require formalized verification.

\begin{itemize}
    \item NFR7 - (The control system repository shall be public for the duration of the capstone project.)
    \item NFR8 - (The control system repository shall be made private upon completion of the project.)
\end{itemize}

\newpage

\section{Unit Testing}

Unit testing was carried out by creating single-module environments in which module inputs are supplied via manually-created timeseries signals (created via Simulink's Root-level importer and Signal Editor), and outputs are logged during simulation for inspection with a scope-like interface (Simulink Data Inspector). These environments are shown for each module below.

\subsection{Driver Interface Module}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/DIsim.JPG}
    \centering
    \caption{Driver Interface - Unit Test Simulation Environment}
\end{figure}

\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
DI1.1 & FR-CRIT-FAIL-VDR1 (VnV Plan rev0) & APPS1 Pot signal $>$ 4096 & APPS1 internal fault is set; APPS2 is used for torque request & APPS1 internal fault is set; APPS2 is used for torque request & Pass\\
\hline
\end{tabular}

\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
DI1.2 & FR-CRIT-FAIL-VDR1 (VnV Plan rev0) & APPS2 Pot signal $>$ 4096 & APPS2 internal fault is set; APPS1 is used for torque request & APPS2 internal fault is set; APPS1 is used for torque request & Pass\\
\hline
\end{tabular}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/DI1_1.JPG}
    \centering
    \caption{DI1.1 and DI1.2 Simulation Results}
\end{figure}

\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
DI1.3 & FR-CRIT-FAIL-VDR1 (VnV Plan rev0) & BPPS Pot signal $>$ 4096 &  Internal fault is set; Driver Interface reports Error status & Internal fault is set; Driver Interface reports Error status & Pass\\
\hline
\end{tabular}

\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
DI1.4 & FR-CRIT-FAIL-VDR1 (VnV Plan rev0) & Steering Pot signal $>$ 4096 & Steering internal fault is set; Driver Interface reports Error status & Steering internal fault is set; Driver Interface reports Error status & Pass\\
\hline
\end{tabular}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/DI1_1.JPG}
    \centering
    \caption{DI1.3 and DI1.4 Simulation Results}
\end{figure}

\newpage

\subsection{Vehicle Dynamics Module}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/VDsim.JPG}
    \centering
    \caption{Vehicle Dynamics - Unit Test Simulation Environment}
\end{figure}


\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
VD1 & FR-WARN-VDR1 (VnV Plan rev0) & Torque Request \& Brake Pedal Position $>$ 0 & Motor positive torque limits = 0 & Motor positive torque limits = 0  & Pass\\
\hline
\end{tabular}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/VD1.JPG}
    \centering
    \caption{VD1 Simulation Results}
\end{figure}

\newpage

\subsection{Motor Interface Module}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/MIsim.JPG}
    \centering
    \caption{Motor Interface - Unit Test Simulation Environment}
\end{figure}

\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
MI1 & TMR1 TMR2 TMR3 TMR4 (SRS rev0) & AMK startup feedback signals (AMK documentation 8.2.6) & Control signals sent according to AMK 8.2.6; Motor interface reports 'Running' state & Control signals sent according to AMK 8.2.6; Motor interface reports 'Running' state  & Pass\\
\hline
\end{tabular} \\

\noindent Note: TMR6 and TMR7 from the SRS are validated under test case VD1.

\newpage

\subsection{Battery Monitor Module}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/BMsim.JPG}
    \centering
    \caption{Battery Monitor - Unit Test Simulation Environment}
\end{figure}


\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
BM1 &  FR-CRIT-FAIL-AMR1 (VnV Plan rev0) & Contactors: HV positive = 0; HV negative = 0; precharge = 1 & Battery Monitor reports Error state on startup & Battery Monitor reports Error state on startup  & Pass\\
\hline
\end{tabular} \\

\noindent Note: AMR2-9 are no longer applicable due to scope reduction; the Formula team now intends to use an off-the-shelf BMS, so a full battery management system is no longer required for this system.

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/BM1.JPG}
    \centering
    \caption{BM1 Simulation Results}
\end{figure} 



\section{Integration Testing}

Shown below is the simulation environment for our control system. The Controller model (on the left), containing all the subsystems (tested in Section 3), all running simultaneously and supplying signals to a Plant model (on the right). The Plant model was designed by our team to simulate feedback from the vehicle's sensors and other controllers. AMK motor feedback, vehicle speed and acceleration are simulated using a physics model. Driver Inputs and Battery Contactor states are modelled simply by manually-created timeseries signals. 

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/VCSsim.JPG}
    \centering
    \caption{Vehicle Control System - System Test Simulation Environment}
\end{figure}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/controller.JPG}
    \centering
    \caption{Vehicle Control System - Controller model}
\end{figure}

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/plant.JPG}
    \centering
    \caption{Vehicle Control System - Plant model}
\end{figure}

\vspace{\tableVspace}\noindent
\begin{tabular}{| p{\TID} | p{\Requirement} | p{\TestInput} | p{\ExpResult} | p{\ActResult} | p{\Result} | }
\hline
\rowcolor[gray]{0.9}
\hline
TID & Requirement & Test Input & Expected Result & Actual Result & Result \\
\hline
VCS1 &  MSR1 MSR2 MSR5 (SRS rev0) & Contactors in expected startup sequence; Driver inputs prompt vehicle start (button and brakes engaged), followed by throttle inputs & Governor issues ready-to-drive once BM, DI and MI report 'running' state; vehicle responds to throttle input & Governor issues ready-to-drive once BM, DI and MI report 'running' state; vehicle responds to throttle inputs & Pass\\
\hline
\end{tabular} \\

\begin{figure}[h!]
    \includegraphics[width=\textwidth]{images/VCS1.JPG}
    \centering
    \caption{VCS1 Simulation Results}
\end{figure} 

\section{Changes Due to Testing}

The process of validation (as well as instructor questioning during the PoC and rev0 demos) has highlighted the need to add control logic to handle various edge cases, such as errors in driver input sensors. This was implemented in the Driver Interface module, in the form of sub-modules which monitor each potentiometer reading for error states. When the Driver Interface detects any such errors, this error state is reported to the rest of the control system, and the motor torque request is set to 0 for the vehicle to coast down.

\section{Automated Testing}

It was not in the project scope or timeline to develop automated test tools for model-based development. Testing was carried out by building manual simulation environments as described in the VnV Plan.
		
\section{Trace to Requirements}

Corresponding requirements are mentioned in-line with validation summaries throughout Sections 2, 3 and 4.

\section{Code Coverage Metrics}

The concept of code coverage is not applicable in model-based design.

\bibliographystyle{plainnat}
\bibliography{../../refs/References}

\newpage{}
\section*{Appendix --- Reflection}

The testing procedure (simulation environments) outlined in the VnV Plan, for system-level and unit tests, was adhered to fairly closely. This can be seen in the unit test and system test environments above, where module/system inputs are simulated using plant models, or supplied from manual signal building tools, and outputs are inspected using signal visualization tools.\\
Despite this, in terms of specific test cases, we found our VnV Plan to be inadequate for testing minimum-level functionality of the control system. This is due primarily to its lack of consideration of unit tests, as this was early-stage of the project well before Design Documentation. Moreover, as our team honed our project's scope based on continual feedback and changing requirements from McMaster Formula Electric, the control system had major functionality cuts - most notably, the removal of the cooling control subsystem and battery management system (Formula will be using an off-the-shelf BMS) - as well as architecture design changes following early design discussions, such as a re-design of the "torque path" (any and all control logic between driver input and motor command output; in our control system, this was reflected in the Driver Interface -$>$ Vehicle Dynamnics -$>$ Motor Interface module flow). \\
In the future, we would know to better manage interaction with our "user" - Mac Formula Electric. Discussion of specific control system topics was fragmented across time and across team members - in hindsight, it would've been ideal to call a team-lead "all-hands" in mid-Fall to review the control system's intended role and function on the vehicle, and how this relates to each team-lead's system.


\end{document}